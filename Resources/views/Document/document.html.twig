{%- extends "EkynaCommerceBundle:Document:base.html.twig" -%}


{%- import "EkynaCommerceBundle:Document:macros.html.twig" as macro -%}

{# --- TITLE --- #}
{%- block doc_title -%}
    <h1>
        {{- ('ekyna_commerce.document.type.' ~ subject.type)|trans }}
        {{ subject.sale.number -}}
    </h1>
    <p>Le {{ date|localizeddate('long', 'none') }}.</p>{# TODO trans #}
{%- endblock doc_title -%}


{# --- ADDRESSES --- #}
{%- block doc_customer -%}
    {{- macro.render_customer(subject.customer) -}}
{%- endblock doc_customer -%}

{%- block doc_invoice_address -%}
    {{- macro.render_address(subject.invoiceAddress) -}}
{%- endblock doc_invoice_address -%}

{%- block doc_delivery_address -%}
    {%- if subject.deliveryAddress is not empty -%}
        {{ macro.render_address(subject.deliveryAddress) }}
    {%- else -%}
        {{ macro.render_address(subject.invoiceAddress) }}
    {%- endif -%}
{%- endblock doc_delivery_address -%}


{%- set currency = subject.currency -%}
{%- set multiple_taxes = subject.hasMultipleTaxes() -%}
{%- set line_discount = subject.hasLineDiscount() -%}

{%- set columns_count = 5 -%}
{%- if multiple_taxes %}{% set columns_count = columns_count + 1 %}{% endif -%}
{%- if line_discount %}{% set columns_count = columns_count + 3 %}{% endif -%}

{# --- LINES --- #}
{%- block doc_lines -%}
<table class="bloc table details">
    <thead>
    <tr>
        <th>{{ 'ekyna_core.field.designation'|trans }}</th>
        <th>{{ 'ekyna_core.field.reference'|trans }}</th>
        <th>{{ 'ekyna_commerce.sale.field.net_unit'|trans }}</th>
        {% if multiple_taxes -%}
        <th>{{ 'ekyna_commerce.sale.field.tax_rate'|trans }}</th>
        {%- endif %}
        <th>{{ 'ekyna_core.field.quantity'|trans }}</th>
        {% if line_discount -%}
        <th>{{ 'ekyna_commerce.sale.field.gross'|trans }}</th>
        <th colspan="2">{{ 'ekyna_commerce.sale.field.discount'|trans }}</th>
        {%- endif %}
        <th>{{ 'ekyna_commerce.sale.field.net_total'|trans }}</th>
    </tr>
    </thead>

    {# GOODS #}
    {% set grossTotal, discountTotal, baseTotal = 0, 0, 0 %}
    {% set goodLines = subject.linesByType('good') %}
    {% set discountLines = subject.linesByType('discount') -%}
    {% set shipmentLines = subject.linesByType('shipment') -%}

    <tbody class="stripped">
    {% for line in goodLines %}
        {% if not line.saleItem.private %}
        {% set grossTotal = grossTotal + line.gross %}
        {% set discountTotal = discountTotal + line.discount %}
        {% set baseTotal = baseTotal + line.base %}
        <tr>
            <td>
                {{- line.designation -}}
                {%- if line.description is not empty -%}
                    <br><p class="description">{{ line.description|nl2br }}</p>
                {%- endif -%}
            </td>
            <td>{{ line.reference }}</td>
            <td class="text-right">{{ line.unit|localizedcurrency(currency) }}</td>
            {% if multiple_taxes %}
            <td class="text-right">
                {%- for rate in line.taxRates -%}
                    {{- rate|localizednumber }}%
                    {%- if not loop.last %}, {% endif -%}
                {%- else -%}
                    &nbsp;
                {%- endfor -%}
            </td>
            {% endif %}
            <td class="text-right">{{ line.quantity|localizednumber }}</td>{# TODO Packing format #}
            {% if line_discount %}
            <td class="text-right">
                {{- line.gross|localizedcurrency(currency) -}}
            </td>
            {%- if 0 < line.discount -%}
            <td class="text-right">
                {%- for rate in line.discountRates -%}
                    {{- rate|localizednumber }}%
                    {%- if not loop.last %}, {% endif -%}
                {%- else -%}
                    &nbsp;
                {%- endfor -%}
            </td>
            <td class="text-right">-{{- line.discount|localizedcurrency(currency) -}}</td>
            {%- else -%}
            <td class="text-right">&nbsp;</td>
            <td class="text-right">&nbsp;</td>
            {%- endif -%}
            {% endif %}
            <td class="text-right">{{ line.base|localizedcurrency(currency) }}</td>
        </tr>
        {% endif %}
    {% endfor %}
    </tbody>


    <tbody class="spacer"><tr><td colspan="{{ columns_count }}">&nbsp;</td></tr></tbody>

    {% if line_discount or (1 < goodLines|length and discountLines is not empty) -%}
    <tbody class="totals">
        <tr>
            <td colspan="{{ columns_count - (line_discount ? 4 : 1) }}">{{ 'ekyna_commerce.sale.field.gross_totals'|trans }}</td>
            {% if line_discount -%}
            <td class="text-right">{{ grossTotal|localizedcurrency(currency) }}</td>
            <td class="text-right" colspan="2">
                {%- if 0 < discountTotal %}-{% endif %}{{ discountTotal|localizedcurrency(currency) -}}
            </td>
            {%- endif %}
            <td class="text-right">{{ baseTotal|localizedcurrency(currency) }}</td>
        </tr>
    </tbody>
    {%- endif %}


    {# DISCOUNTS #}
    {% if discountLines is not empty -%}
    <tbody class="totals">
    {% for line in discountLines -%}
        <tr>
            <td colspan="{{ columns_count - 2 }}">&nbsp;</td>
            <th>
                {%- if line.designation is empty -%}
                    {{- 'ekyna_commerce.adjustment.type.discount'|trans }}
                {%- else -%}
                    {{- line.designation -}}
                {%- endif -%}
            </th>
            <td class="total text-right">-{{ line.base|localizedcurrency(currency) }}</td>
        </tr>
    {%- endfor %}
    </tbody>
    {%- endif %}


    {# SHIPMENT #}
    {% if shipmentLines is not empty -%}
    <tbody class="totals">
    {% for line in shipmentLines -%}
        <tr>
            <td colspan="{{ columns_count - 2 }}">&nbsp;</td>
            <th>{{ 'ekyna_commerce.sale.field.shipping_cost'|trans }}</th>
            <td class="total text-right">{{ line.base|localizedcurrency(currency) }}</td>
        </tr>
    {%- endfor %}
    </tbody>
    {%- endif %}


    {# TOTALS #}
    <tbody class="totals">
        <tr>
            <td colspan="{{ columns_count - 2 }}" rowspan="3">&nbsp;</td>
            <th>{{ 'ekyna_commerce.sale.field.net_total'|trans }}</th>
            <td class="total text-right">{{ (subject.goodsBase - subject.discountBase + subject.shipmentBase)|localizedcurrency(currency) }}</td>
        </tr>
        <tr>
            <th>{{ 'ekyna_commerce.sale.field.tax_total'|trans }}</th>
            <td class="total text-right">{{ subject.taxesTotal|localizedcurrency(currency) }}</td>
        </tr>
        <tr>
            <th>{{ 'ekyna_commerce.sale.field.grand_total'|trans }}</th>
            <td class="total final text-right">{{ subject.grandTotal|localizedcurrency(currency) }}</td>
        </tr>
    </tbody>
</table>

{# Taxes details #}
{% if subject.taxesDetails is not empty -%}
<table class="table taxes">
    <thead>
        <tr>
            <th>{{ 'ekyna_commerce.tax.label.singular'|trans }}</th>
            <th>{{ 'ekyna_commerce.sale.field.tax_total'|trans }}</th>
        </tr>
    </thead>
    <tbody>
        {% for details in subject.taxesDetails -%}
        <tr>
            <th>{{ details.name }}</th>
            <td class="text-right">{{ details.amount|localizedcurrency(currency) }}</td>
        </tr>
        {%- endfor %}
    </tbody>
</table>
{%- endif %}
{%- endblock doc_lines %}
