define(["jquery","bootstrap/dialog","ekyna-commerce/templates","routing","ekyna-ui"],function(a,b,c,d){"use strict";return a.fn.requiredInputWidget=function(){return this.each(function(){var b=a(this),c=b.closest(".form-group");b.on("keyup",function(a){0===b.val().trim().length?(c.removeClass("has-success").addClass("has-error"),a.preventDefault(),a.stopPropagation()):c.removeClass("has-error").addClass("has-success")})}),this},a.fn.relayPointWidget=function(){return this.each(function(){function e(){H=new b({title:"Choisissez un point relais",size:b.SIZE_WIDE,cssClass:"commerce-relay-point-dialog",message:"<p>Please wait...</p>",buttons:[{label:"Fermer",cssClass:"btn-default",action:function(a){a.close()}},{label:"Valider",cssClass:"btn-primary"}]}),H.realize(),H.getModalBody().html(c["@EkynaCommerce/Js/pick_relay_point.html.twig"].render()),z=H.getModalBody().find(".rp-list"),y=H.getModalBody().find(".rp-form"),B=H.getModalBody().find(".select-search-point"),A=H.getModalFooter().find(".btn-primary").prop("disabled",!0),y.find('input[type="text"][required]').requiredInputWidget(),y.on("keyup",'input[type="text"]',function(){J&&(J.abort(),J=null),I&&(clearTimeout(I),I=null),B.addClass("disabled");var a=f();a&&(A.prop("disabled",!0),z.empty().loadingSpinner(),I=setTimeout(function(){h(a),m(a)},1e3))}),z.on("change",'input[type="radio"]',function(){var a=z.find('input[type="radio"]:checked');1===a.length&&j(a.val())}),A.on("click",function(){if(!A.prop("disabled")){var b=z.find('input[type="radio"]:checked');if(1===b.length){H.getModalContent().loadingSpinner(),k();var c=a.ajax({url:d.generate("ekyna_commerce_api_shipment_gateway_get_relay_point",{gateway:F}),method:"GET",data:{number:b.val()},dataType:"json"});c.done(function(a){a.hasOwnProperty("relay_point")&&a.relay_point&&(k(a.relay_point),H.close())}),c.always(function(){H.getModalContent().loadingSpinner("off")})}}}),B.on("click",function(){B.hasClass("disabled")||K&&M&&new google.maps.event.trigger(M,"click")}),H.onShown(function(){if(D&&(y.find('input[name="street"]').val(D.street).trigger("keyup"),y.find('input[name="postalCode"]').val(D.postal_code).trigger("keyup"),y.find('input[name="city"]').val(D.city).trigger("keyup")),"object"==typeof google&&google.hasOwnProperty("maps"))return void g();window.initRelayPointMap=g;var a=document.createElement("script");a.src="https://maps.googleapis.com/maps/api/js?key="+r.data("map-api-key")+"&callback=initRelayPointMap",document.body.appendChild(a)}),H.open()}function f(){for(var a={street:"",postalCode:"",city:""},b=H.getModalBody().find("form").serializeArray(),c=0;c<b.length;c++)a[b[c].name]=b[c].value.trim();return a.street.length&&a.postalCode.length&&a.city.length?a:null}function g(){p={path:"M14.21,42C14.21,29,26,23.94,26,13.5a12.5,12.5,0,0,0-25,0C1,24,12.79,29,12.79,42Z",size:new google.maps.Size(27,43),anchor:new google.maps.Point(13,43),fillColor:"white",fillOpacity:.6,strokeColor:"#337ab7",strokeWeight:1,strokeOpacity:.6},q={path:"M14.21,42C14.21,29,26,23.94,26,13.5a12.5,12.5,0,0,0-25,0C1,24,12.79,29,12.79,42Z",size:new google.maps.Size(27,43),anchor:new google.maps.Point(13,43),fillColor:"#337ab7",fillOpacity:1,strokeColor:"white",strokeWeight:1,strokeOpacity:1},K=new google.maps.Map(document.getElementById("relay-point-map"),{center:{lat:46.52863469527167,lng:2.43896484375},zoom:5,disableDefaultUI:!0}),L=new google.maps.Geocoder,h(f())}function h(a){K&&(M&&(M.setMap(null),M=null),a&&L.geocode({address:a.street+" "+a.postalCode+" "+a.city},function(b,c){"OK"===c?(K.setCenter(b[0].geometry.location),M=new google.maps.Marker({map:K,position:b[0].geometry.location}),M.addListener("click",function(){o&&(o.setMap(null),o=null),o=new google.maps.InfoWindow({content:"<p>"+a.street+"<br>"+a.postalCode+" "+a.city+"</p>"}),o.open(K,M),K.setZoom(12),K.setCenter(M.getPosition())}),B.removeClass("disabled")):console.log("Geocode was not successful for the following reason: "+c)}))}function i(b){if(K){for(var c=0;c<N.length;c++)N[c].setMap(null);N=[],a(b.relay_points).each(function(a,b){var c=new google.maps.Marker({map:K,position:{lat:parseFloat(b.latitude),lng:parseFloat(b.longitude)},icon:p});c.set("id",b.number),c.addListener("click",function(){j(b.number)}),N.push(c)});var d=new google.maps.LatLngBounds;for(c=0;c<N.length;c++)d.extend(N[c].getPosition());K.fitBounds(d)}}function j(a){if(z.find(".rp-point.active").removeClass("active").find(".rp-details").slideUp(),z.find('input[type="radio"]').prop("checked",!1),K)for(var b=0;b<N.length;b++)N[b].setIcon(p);var d=z.find('input[type="radio"][value="'+a+'"]');if(1===d.length){if(d.prop("checked",!0),d.closest(".rp-point").addClass("active").find(".rp-details").slideDown(),z.parent().scrollTop(d.closest(".rp-point").position().top),A.prop("disabled",!1),!K)return;o&&(o.setMap(null),o=null);var e=d.data("point");for(b=0;b<N.length;b++)if(N[b].get("id")===a){N[b].setIcon(q),o=new google.maps.InfoWindow({content:c["@EkynaCommerce/Js/relay_point.html.twig"].render(e)}),o.open(K,N[b]),K.setZoom(15),K.setCenter(N[b].getPosition());break}}}function k(a){void 0===a&&C&&C.platform===G&&(a=C),a?(s.val(a.number),t.html(c["@EkynaCommerce/Js/relay_point.html.twig"].render(a)).show(),u.hide()):(s.val(null),t.empty().hide(),u.show())}function l(){k()}function m(b){J=a.ajax({url:d.generate("ekyna_commerce_api_shipment_gateway_list_relay_points",{gateway:F}),method:"GET",data:b}),J.done(function(a){z.html(c["@EkynaCommerce/Js/relay_point_list.html.twig"].render(a)),i(a)}),J.always(function(){z.loadingSpinner("off")})}function n(){var a=null;a=1===x.length?x.find("option:selected"):x.filter(":checked").eq(0),1===a.length?(E=a.data("relay"),G=a.data("platform"),F=a.data("gateway")):E=G=F=!1,E&&G&&F?(v.removeClass("disabled").on("click",e),k(),r.slideDown()):(r.slideUp(),k(!1),v.addClass("disabled").off("click",e))}var o,p,q,r=a(this),s=r.find('input[type="hidden"]'),t=r.find("p.relay-point-address"),u=r.find("p.relay-point-none"),v=r.find("button.relay-point-search"),w=r.find("button.relay-point-clear"),x=r.closest("form").find('.shipment-method, input[name="shipment[shipmentMethod]"]'),y=null,z=null,A=null,B=null,C=s.data("initial"),D=s.data("search"),E=!1,F=!1,G=!1,H=null,I=null,J=null,K=null,L=null,M=null,N=[];v.addClass("disabled"),w.on("click",l),x.on("change",n),n()}),this},{init:function(a){a.relayPointWidget()}}});