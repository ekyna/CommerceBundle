define(["jquery","bootstrap/dialog","ekyna-commerce/templates","routing","ekyna-ui"],function(a,b,c,d){"use strict";return a.fn.requiredInputWidget=function(){return this.each(function(){var b=a(this),c=b.closest(".form-group");b.on("keyup",function(a){0===b.val().trim().length?(c.removeClass("has-success").addClass("has-error"),a.preventDefault(),a.stopPropagation()):c.removeClass("has-error").addClass("has-success")})}),this},a.fn.relayPointWidget=function(){return this.each(function(){function e(){F=new b({title:"Choisissez un point relais",size:b.SIZE_WIDE,cssClass:"commerce-relay-point-dialog",message:"<p>Please wait...</p>",buttons:[{label:"Fermer",cssClass:"btn-default",action:function(a){a.close()}},{label:"Valider",cssClass:"btn-primary"}]}),F.realize(),F.getModalBody().html(c["pick_relay_point.html.twig"].render()),x=F.getModalBody().find(".rp-list"),w=F.getModalBody().find(".rp-form"),z=F.getModalBody().find(".select-search-point"),y=F.getModalFooter().find(".btn-primary").prop("disabled",!0),w.find('input[type="text"][required]').requiredInputWidget(),w.on("keyup",'input[type="text"]',function(){H&&(H.abort(),H=null),G&&(clearTimeout(G),G=null),z.addClass("disabled");var a=f();a&&(y.prop("disabled",!0),x.empty().loadingSpinner(),G=setTimeout(function(){h(a),m(a)},1e3))}),x.on("change",'input[type="radio"]',function(){var a=x.find('input[type="radio"]:checked');1===a.length&&j(a.val())}),y.on("click",function(){if(!y.prop("disabled")){var b=x.find('input[type="radio"]:checked');if(1===b.length){F.getModalContent().loadingSpinner(),k();var c=a.ajax({url:d.generate("ekyna_commerce_api_shipment_gateway_get_relay_point",{gateway:D}),method:"GET",data:{number:b.val()},dataType:"json"});c.done(function(a){a.hasOwnProperty("relay_point")&&a.relay_point&&(k(a.relay_point),F.close())}),c.always(function(){F.getModalContent().loadingSpinner("off")})}}}),z.on("click",function(){z.hasClass("disabled")||I&&K&&new google.maps.event.trigger(K,"click")}),F.onShown(function(){if(B&&(w.find('input[name="street"]').val(B.street).trigger("keyup"),w.find('input[name="postalCode"]').val(B.postal_code).trigger("keyup"),w.find('input[name="city"]').val(B.city).trigger("keyup")),"object"==typeof google&&google.hasOwnProperty("maps"))return void g();window.initRelayPointMap=g;var a=document.createElement("script");a.src="https://maps.googleapis.com/maps/api/js?key="+p.data("map-api-key")+"&callback=initRelayPointMap",document.body.appendChild(a)}),F.open()}function f(){for(var a={street:"",postalCode:"",city:""},b=F.getModalBody().find("form").serializeArray(),c=0;c<b.length;c++)a[b[c].name]=b[c].value.trim();return a.street.length&&a.postalCode.length&&a.city.length?a:null}function g(){I=new google.maps.Map(document.getElementById("relay-point-map"),{center:{lat:46.52863469527167,lng:2.43896484375},zoom:5,disableDefaultUI:!0}),J=new google.maps.Geocoder,h(f())}function h(a){I&&(K&&(K.setMap(null),K=null),a&&J.geocode({address:a.street+" "+a.postalCode+" "+a.city},function(b,c){"OK"===c?(I.setCenter(b[0].geometry.location),K=new google.maps.Marker({map:I,position:b[0].geometry.location}),K.addListener("click",function(){o&&(o.setMap(null),o=null),o=new google.maps.InfoWindow({content:"<p>"+a.street+"<br>"+a.postalCode+" "+a.city+"</p>"}),o.open(I,K),I.setZoom(12),I.setCenter(K.getPosition())}),z.removeClass("disabled")):console.log("Geocode was not successful for the following reason: "+c)}))}function i(b){if(I){for(var c=0;c<L.length;c++)L[c].setMap(null);L=[],a(b.relay_points).each(function(a,b){var c=new google.maps.Marker({map:I,position:{lat:parseFloat(b.latitude),lng:parseFloat(b.longitude)},icon:M});c.set("id",b.number),c.addListener("click",function(){j(b.number)}),L.push(c)});var d=new google.maps.LatLngBounds;for(c=0;c<L.length;c++)d.extend(L[c].getPosition());I.fitBounds(d)}}function j(a){if(x.find(".rp-point.active").removeClass("active").find(".rp-details").slideUp(),x.find('input[type="radio"]').prop("checked",!1),I)for(var b=0;b<L.length;b++)L[b].setIcon(M);var d=x.find('input[type="radio"][value="'+a+'"]');if(1===d.length){if(d.prop("checked",!0),d.closest(".rp-point").addClass("active").find(".rp-details").slideDown(),x.parent().scrollTop(d.closest(".rp-point").position().top),y.prop("disabled",!1),!I)return;o&&(o.setMap(null),o=null);var e=d.data("point");for(b=0;b<L.length;b++)if(L[b].get("id")===a){L[b].setIcon(N),o=new google.maps.InfoWindow({content:c["relay_point.html.twig"].render(e)}),o.open(I,L[b]),I.setZoom(15),I.setCenter(L[b].getPosition());break}}}function k(a){void 0===a&&A&&A.platform===E&&(a=A),a?(q.val(a.number),r.html(c["relay_point.html.twig"].render(a)).show(),s.hide()):(q.val(null),r.empty().hide(),s.show())}function l(){k()}function m(b){H=a.ajax({url:d.generate("ekyna_commerce_api_shipment_gateway_list_relay_points",{gateway:D}),method:"GET",data:b}),H.done(function(a){x.html(c["relay_point_list.html.twig"].render(a)),i(a)}),H.always(function(){x.loadingSpinner("off")})}function n(){var a=null;a=1===v.length?v.find("option:selected"):v.filter(":checked").eq(0),1===a.length?(C=a.data("relay"),E=a.data("platform"),D=a.data("gateway")):C=E=D=!1,C&&E&&D?(t.removeClass("disabled").on("click",e),k(),p.slideDown()):(p.slideUp(),k(!1),t.addClass("disabled").off("click",e))}var o,p=a(this),q=p.find('input[type="hidden"]'),r=p.find("p.relay-point-address"),s=p.find("p.relay-point-none"),t=p.find("button.relay-point-search"),u=p.find("button.relay-point-clear"),v=p.closest("form").find('.shipment-method, input[name="shipment[shipmentMethod]"]'),w=null,x=null,y=null,z=null,A=q.data("initial"),B=q.data("search"),C=!1,D=!1,E=!1,F=null,G=null,H=null,I=null,J=null,K=null,L=[],M={path:"M14.21,42C14.21,29,26,23.94,26,13.5a12.5,12.5,0,0,0-25,0C1,24,12.79,29,12.79,42Z",size:new google.maps.Size(27,43),anchor:new google.maps.Point(13,43),fillColor:"white",fillOpacity:.6,strokeColor:"#337ab7",strokeWeight:1,strokeOpacity:.6},N={path:"M14.21,42C14.21,29,26,23.94,26,13.5a12.5,12.5,0,0,0-25,0C1,24,12.79,29,12.79,42Z",size:new google.maps.Size(27,43),anchor:new google.maps.Point(13,43),fillColor:"#337ab7",fillOpacity:1,strokeColor:"white",strokeWeight:1,strokeOpacity:1};t.addClass("disabled"),u.on("click",l),v.on("change",n),n()}),this},{init:function(a){a.relayPointWidget()}}});