define(["jquery","bootstrap/dialog","ekyna-commerce/templates","routing","ekyna-spinner"],function(T,q,x,D){"use strict";return T.fn.requiredInputWidget=function(){return this.each(function(){var t=T(this),n=t.closest(".form-group");t.on("keyup",function(e){0===t.val().trim().length?(n.removeClass("has-success").addClass("has-error"),e.preventDefault(),e.stopPropagation()):n.removeClass("has-error").addClass("has-success")})}),this},T.fn.relayPointWidget=function(){return this.each(function(){var a,c,u,t=T(this),g=t.find('input[type="hidden"]'),f=t.find("p.relay-point-address"),m=t.find("p.relay-point-none"),y=t.find("button.relay-point-search"),e=t.find("button.relay-point-clear"),h=t.closest("form").find('.shipment-method, input[name="shipment[shipmentMethod]"]'),n=null,w=null,i=null,l=null,o=null,k=g.data("initial"),C=g.data("search"),v=!1,b=!1,_=!1,r=null,M=null,P=null,s=null,E=null,d=null,p=[];function I(){(r=new q({title:"Choisissez un point relais",size:q.SIZE_WIDE,cssClass:"commerce-relay-point-dialog",message:"<p>Please wait...</p>",buttons:[{label:"Fermer",cssClass:"btn-default",action:function(e){e.close()}},{label:"Valider",cssClass:"btn-primary"}]})).realize(),r.getModalBody().html(x["@EkynaCommerce/Js/pick_relay_point.html.twig"].render()),i=r.getModalBody().find(".rp-list"),n=r.getModalBody().find(".rp-form"),w=r.getModalBody().find(".rp-error"),o=r.getModalBody().find(".select-search-point"),l=r.getModalFooter().find(".btn-primary").prop("disabled",!0),n.find('input[type="text"][required]').requiredInputWidget(),n.on("keyup",'input[type="text"]',function(){P&&(P.abort(),P=null),M&&(clearTimeout(M),M=null),o.addClass("disabled");var t=z();t&&(l.prop("disabled",!0),i.empty().loadingSpinner(),M=setTimeout(function(){var e;O(t),e=t,w.hide(),(P=T.ajax({url:D.generate("api_ekyna_commerce_shipment_gateway_list_relay_points",{gateway:b}),method:"GET",data:e})).done(function(e){i.html(x["@EkynaCommerce/Js/relay_point_list.html.twig"].render(e));if(s){for(var t=0;t<p.length;t++)p[t].setMap(null);if(e.hasOwnProperty("error")&&e.error&&w.show().find("> div").html(e.error),e.hasOwnProperty("relay_points")){p=[],T(e.relay_points).each(function(e,t){var n=new google.maps.Marker({map:s,position:{lat:parseFloat(t.latitude),lng:parseFloat(t.longitude)},icon:c});n.set("id",t.number),n.addListener("click",function(){W(t.number)}),p.push(n)});var n=new google.maps.LatLngBounds;for(t=0;t<p.length;t++)n.extend(p[t].getPosition());s.fitBounds(n)}}}),P.always(function(){i.loadingSpinner("off")})},1e3))}),i.on("change",'input[type="radio"]',function(){var e=i.find('input[type="radio"]:checked');1===e.length&&W(e.val())}),l.on("click",function(){var e;l.prop("disabled")||1===(e=i.find('input[type="radio"]:checked')).length&&(r.getModalContent().loadingSpinner(),S(),(e=T.ajax({url:D.generate("api_ekyna_commerce_shipment_gateway_get_relay_point",{gateway:b}),method:"GET",data:{number:e.val()},dataType:"json"})).done(function(e){e.hasOwnProperty("relay_point")&&e.relay_point&&(S(e.relay_point),r.close())}),e.always(function(){r.getModalContent().loadingSpinner("off")}))}),o.on("click",function(){o.hasClass("disabled")||s&&d&&new google.maps.event.trigger(d,"click")}),r.onShown(function(){var e;C&&(n.find('input[name="street"]').val(C.street).trigger("keyup"),n.find('input[name="postalCode"]').val(C.postal_code).trigger("keyup"),n.find('input[name="city"]').val(C.city).trigger("keyup")),"object"==typeof google&&google.hasOwnProperty("maps")?B():(window.initRelayPointMap=B,(e=document.createElement("script")).src="https://maps.googleapis.com/maps/api/js?key="+t.data("map-api-key")+"&callback=initRelayPointMap",document.body.appendChild(e))}),r.open()}function z(){for(var e={street:"",postalCode:"",city:""},t=r.getModalBody().find("form").serializeArray(),n=0;n<t.length;n++)e[t[n].name]=t[n].value.trim();return e.street.length&&e.postalCode.length&&e.city.length?e:null}function B(){c={path:"M14.21,42C14.21,29,26,23.94,26,13.5a12.5,12.5,0,0,0-25,0C1,24,12.79,29,12.79,42Z",size:new google.maps.Size(27,43),anchor:new google.maps.Point(13,43),fillColor:"white",fillOpacity:.6,strokeColor:"#337ab7",strokeWeight:1,strokeOpacity:.6},u={path:"M14.21,42C14.21,29,26,23.94,26,13.5a12.5,12.5,0,0,0-25,0C1,24,12.79,29,12.79,42Z",size:new google.maps.Size(27,43),anchor:new google.maps.Point(13,43),fillColor:"#337ab7",fillOpacity:1,strokeColor:"white",strokeWeight:1,strokeOpacity:1},s=new google.maps.Map(document.getElementById("relay-point-map"),{center:{lat:46.52863469527167,lng:2.43896484375},zoom:5,disableDefaultUI:!0}),E=new google.maps.Geocoder,O(z())}function O(n){s&&(d&&(d.setMap(null),d=null),n&&E.geocode({address:n.street+" "+n.postalCode+" "+n.city},function(e,t){"OK"===t?(s.setCenter(e[0].geometry.location),(d=new google.maps.Marker({map:s,position:e[0].geometry.location})).addListener("click",function(){a&&(a.setMap(null),a=null),(a=new google.maps.InfoWindow({content:"<p>"+n.street+"<br>"+n.postalCode+" "+n.city+"</p>"})).open(s,d),s.setZoom(12),s.setCenter(d.getPosition())}),o.removeClass("disabled")):console.log("Geocode was not successful for the following reason: "+t)}))}function W(e){if(i.find(".rp-point.active").removeClass("active").find(".rp-details").slideUp(),i.find('input[type="radio"]').prop("checked",!1),s)for(var t=0;t<p.length;t++)p[t].setIcon(c);var n=i.find('input[type="radio"][value="'+e+'"]');if(1===n.length&&(n.prop("checked",!0),n.closest(".rp-point").addClass("active").find(".rp-details").slideDown(),i.parent().scrollTop(n.closest(".rp-point").position().top),l.prop("disabled",!1),s)){a&&(a.setMap(null),a=null);for(var o=n.data("point"),t=0;t<p.length;t++)if(p[t].get("id")===e){p[t].setIcon(u),(a=new google.maps.InfoWindow({content:x["@EkynaCommerce/Js/relay_point.html.twig"].render(o)})).open(s,p[t]),s.setZoom(15),s.setCenter(p[t].getPosition());break}}}function S(e){(e=void 0===e&&k&&k.platform===_?k:e)?(g.val(e.number),f.html(x["@EkynaCommerce/Js/relay_point.html.twig"].render(e)).show(),m.hide()):(g.val(null),f.empty().hide(),m.show())}function j(){var e=null;1===(e=1===h.length?h.find("option:selected"):h.filter(":checked").eq(0)).length?(v=e.data("relay"),_=e.data("platform"),b=e.data("gateway")):v=_=b=!1,v&&_&&b?(y.removeClass("disabled").on("click",I),S(),t.slideDown()):(t.slideUp(),S(!1),y.addClass("disabled").off("click",I))}y.addClass("disabled"),e.on("click",function(){S()}),h.on("change",j),j()}),this},{init:function(e){e.relayPointWidget()}}});