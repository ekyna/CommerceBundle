define(["jquery","jquery-ui/ui/widget","ekyna-polyfill"],function(i){"use strict";var t=(navigator.language||navigator.browserLanguage).split("-")[0]||"en";return i.widget("ekyna_commerce.priceType",{options:{taxes:null},_create:function(){if(this.config=i.extend({tax_group:".tax-group-choice",rates:[],precision:2},this.element.data("config")),this.$input=this.element.find(".commerce-price-input"),this.$mode=this.element.find(".commerce-price-mode"),this.$rates=this.element.find(".commerce-price-rates"),this.$value=this.element.find(".commerce-price-value"),this.$group=i(this.config.tax_group),1!==this.$input.length||1!==this.$mode.length||1!==this.$value.length)throw"Missing commerce price type fields";1!==this.$group.length||Array.isArray(this.options.taxes)||this._on(this.$group,{change:this._loadRates}),this._on(this.$mode,{change:this._display}),this._on(this.$input,{keyup:this._calculate,blur:this._display}),this._loadRates()},_destroy:function(){1!==this.$group.length||Array.isArray(this.options.taxes)||this._off(this.$group,"change"),this._off(this.$mode,"change"),this._off(this.$input,"keyup blur"),this.rates=void 0,this.$input=void 0,this.$mode=void 0,this.$value=void 0,this.$group=void 0},_setOption:function(t,i){this._super(t,i),"taxes"===t&&this._loadRates()},_loadRates:function(){var t,e;this.rates=[],this.$rates.empty(),Array.isArray(this.options.taxes)?this.rates=this.options.taxes:1===this.$group.length?!this.$group.val()||1===(t=this.$group.find("option[value="+this.$group.val()+"]")).length&&(e=this,i.each(t.data("taxes"),function(t,i){e.rates.push(i.rate)})):this.rates=this.config.rates,0<this.rates.length&&(this.rates=this.rates.map(parseFloat),this.$rates.html("&nbsp;("+this.rates.map(function(t){return 100*t+"%"}).join(",&nbsp;")+")")),this._display()},_display:function(){var e=parseFloat(this.$value.val()),s=0,a=this.config.precision;isNaN(e)?this.$input.val(null):(s=Math.fRound(e,a),this.$mode.is(":checked")&&i.each(this.rates,function(t,i){s+=Math.fRound(e*i,a)}),this.$input.val(s.toLocaleString(t,{minimumFractionDigits:a,useGrouping:!1}))),this._calculate()},_calculate:function(){var t=parseFloat(this.$input.val().replace(",",".").replace(" ","")),e=0;if(isNaN(t))return this.$value.val(null),void(this.$input.prop("required")&&this.element.find(".input-group").addClass("has-error"));this.element.find(".input-group").removeClass("has-error"),e=Math.fRound(t,this.config.precision),this.$mode.is(":checked")||(i.each(this.rates,function(t,i){e*=1+i}),e=Math.fRound(e,this.config.precision)),i.each(this.rates,function(t,i){e/=1+i}),e=Math.fRound(e,5),this.$value.val(e)},save:function(){this._calculate()}}),{init:function(t){t.priceType()},save:function(t){t.data("ekyna_commerce.priceType")&&t.priceType("save")},destroy:function(t){t.data("ekyna_commerce.priceType")&&t.priceType("destroy")}}});