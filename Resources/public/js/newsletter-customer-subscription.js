define(["jquery","routing","ekyna-spinner"],function(a,b){function c(b){b.data("NewsletterSubscription")||(b.data("NewsletterSubscription",this),this.$element=b,this.$email=b.find("input[type=email]"),this.customer=this.$element.find("input[type=hidden]").val(),this.$element.on("change","input[type=checkbox]",a.proxy(this.onAudienceClick,this)))}return c.prototype.onAudienceClick=function(b){b.stopPropagation(),b.preventDefault();var c=a(b.target).eq(0);if(c.prop("checked")){var d;d=this.customer?{customer:this.customer}:{email:this.$email.val()},this.subscribe(c,d)}else{if(!this.customer)return!1;this.unsubscribe(c,{customer:this.customer})}return!1},c.prototype.subscribe=function(c,d){this.$element.loadingSpinner("on");var e=this,f=a.ajax({url:b.generate("api_ekyna_commerce_newsletter_subscribe",{key:c.attr("value")}),method:"POST",data:d,dataType:"json"});f.done(function(a){c.prop("checked",a.success),a.hasOwnProperty("errors")}),f.always(function(){e.$element.loadingSpinner("off")})},c.prototype.unsubscribe=function(c,d){this.$element.loadingSpinner("on");var e=this,f=a.ajax({url:b.generate("api_ekyna_commerce_newsletter_unsubscribe",{key:c.attr("value")}),method:"POST",data:d,dataType:"json"});f.done(function(a){c.prop("checked",!a.success),a.hasOwnProperty("errors")}),f.always(function(){e.$element.loadingSpinner("off")})},{init:function(b){a(b).each(function(){new c(a(this))})}}});