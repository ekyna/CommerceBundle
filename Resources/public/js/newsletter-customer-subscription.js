define(["jquery","routing","ekyna-spinner"],function(i,r){function t(e){e.data("NewsletterSubscription")||(e.data("NewsletterSubscription",this),this.$element=e,this.$email=e.find("input[type=email]"),this.customer=this.$element.find("input[type=hidden]").val(),this.$element.on("change","input[type=checkbox]",i.proxy(this.onAudienceClick,this)))}return t.prototype.onAudienceClick=function(e){e.stopPropagation(),e.preventDefault();e=i(e.target).eq(0);if(e.prop("checked")){var t=this.customer?{customer:this.customer}:{email:this.$email.val()};this.subscribe(e,t)}else{if(!this.customer)return!1;this.unsubscribe(e,{customer:this.customer})}return!1},t.prototype.subscribe=function(t,e){this.$element.loadingSpinner("on");var n=this,e=i.ajax({url:r.generate("api_ekyna_commerce_newsletter_subscribe",{key:t.attr("value")}),method:"POST",data:e,dataType:"json"});e.done(function(e){t.prop("checked",e.success),e.hasOwnProperty("errors")}),e.always(function(){n.$element.loadingSpinner("off")})},t.prototype.unsubscribe=function(t,e){this.$element.loadingSpinner("on");var n=this,e=i.ajax({url:r.generate("api_ekyna_commerce_newsletter_unsubscribe",{key:t.attr("value")}),method:"POST",data:e,dataType:"json"});e.done(function(e){t.prop("checked",!e.success),e.hasOwnProperty("errors")}),e.always(function(){n.$element.loadingSpinner("off")})},{init:function(e){i(e).each(function(){new t(i(this))})}}});