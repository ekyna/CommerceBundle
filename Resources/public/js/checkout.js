define(["jquery","ekyna-modal","ekyna-dispatcher","jquery/form"],function(a,b,c){"use strict";function d(){f&&f.abort(),h.loadingSpinner(),f=a.ajax({url:h.data("refresh-url"),dataType:"xml",cache:!1}),f.done(function(a){m(a),h.loadingSpinner("off")}),f.fail(function(){console.log("Failed to update cart checkout content.")})}function e(){document[n]||d()}var f,g={information:".cart-checkout-information","invoice-address":".cart-checkout-invoice-address","delivery-address":".cart-checkout-delivery-address",comment:".cart-checkout-comment",attachments:".cart-checkout-attachments"},h=a(".cart-checkout"),i=h.find(".cart-checkout-customer"),j=h.find(".cart-checkout-forms"),k=h.find(".cart-checkout-submit"),l=function(b){var c=a(b).find("view");1===c.size()&&(1===parseInt(c.attr("empty"))?(j.slideUp(),i.slideUp(),k.slideUp()):(j.show().slideDown(),1===parseInt(c.attr("customer"))?i.slideUp():(i.show().slideDown(),1===parseInt(c.attr("user"))?(i.find(".no-user-case").hide(),i.find(".user-case").show()):(i.find(".no-user-case").show(),i.find(".user-case").hide())),1===parseInt(c.attr("valid"))?k.show().slideDown():k.slideUp()))},m=function(b){var c=a(b);for(var d in g)if(g.hasOwnProperty(d)){var e=c.find(d);1===e.size()&&a(g[d]).html(e.text())}l(b);var f=c.find("view");return 1===f.size()&&(a(".sale-view").replaceWith(a(f.text())),!0)};c.on("ekyna_commerce.sale_view_response",function(a){l(a)}),c.on("ekyna_user.user_status",function(a){d()}),a(document).on("click",".cart-checkout [data-cart-modal]",function(c){c.preventDefault();var d=a(this),e=new b;return e.load({url:d.attr("href")}),a(e).on("ekyna.modal.response",function(a){"xml"===a.contentType&&m(a.content)&&(a.preventDefault(),e.close())}),!1}),a(document).on("click",".cart-checkout [data-cart-xhr]",function(b){b.preventDefault();var c=a(this),d=c.data("confirm");if(d&&d.length&&!confirm(d))return!1;var e=a.ajax({url:a(this).attr("href"),method:"post",dataType:"xml"});return e.done(function(a){m(a)}),!1});var n,o;"undefined"!=typeof document.hidden?(n="hidden",o="visibilitychange"):"undefined"!=typeof document.msHidden?(n="msHidden",o="msvisibilitychange"):"undefined"!=typeof document.webkitHidden&&(n="webkitHidden",o="webkitvisibilitychange"),"undefined"==typeof document.addEventListener||"undefined"==typeof document[n]||document.addEventListener(o,e,!1)});