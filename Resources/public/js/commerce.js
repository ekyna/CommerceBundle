define(["require","exports","jquery","ekyna-commerce/templates","underscore","ekyna-dispatcher","ekyna-form","ekyna-spinner","bootstrap","ekyna-modal","ekyna-flags"],function(o,n,a,i,e,r,d,h,p,s,c){"use strict";function l(t,e,o){t={type:s.prototype.getContentType(e),data:t,jqXHR:e,success:"1"==e.getResponseHeader("X-Commerce-Success"),modal:o};return r.trigger("ekyna_commerce.add_to_cart",t),1}t.prototype.reload=function(){var t,e=this;this.busy||(this.busy=!0,(t=a.ajax({url:this.config.url.widget,method:"GET",dataType:"json",cache:!1})).done(function(t){e.renderWidget(t),e.config.event&&r.trigger(e.config.event,t)}),t.fail(function(){console.log("Failed to reload widget.")}),t.always(function(){e.busy=!1}))},t.prototype.initialize=function(){if(this.$button=this.$element.find(this.config.button),1!=this.$button.length)throw"Widget toggle button not found ! ("+this.config.button+")";if(this.$dropdown=this.$element.find(this.config.dropdown),1!=this.$dropdown.length)throw"Widget content not found ! ("+this.config.dropdown+")";this.$element.on("show.bs.dropdown",this.dropdownShowHandler)},t.prototype.renderWidget=function(t){t=a(this.config.template.render(e.defaults(t,this.defaultData)));this.$element.replaceWith(t),this.$element=t,this.initialize()},t.prototype.loadDropdown=function(){var t,e=this;this.busy||(this.busy=!0,this.$dropdown.loadingSpinner("on"),(t=a.ajax({url:this.config.url.dropdown,method:"GET",dataType:"html",data:this.$element.data("data"),cache:!1})).done(function(t){e.$dropdown.html(t);t=e.$dropdown.find("form");t.length&&d.create(t).init()}),t.fail(function(){console.log("Failed to load widget dropdown.")}),t.always(function(){e.$dropdown.loadingSpinner("off"),e.busy=!1}))},t.prototype.onDropdownShow=function(){this.$dropdown.is(":empty")&&this.loadDropdown()},t.prototype.onWindowFocus=function(){var t=this;this.busy||this.preventReload||(this.preventReload=!0,setTimeout(function(){t.preventReload=!1},1e4),this.reload())};var u=t;function t(t){if(this.config=e.defaults(t,{tag:"li",icon:"> a > span",button:"> a.dropdown-toggle",dropdown:"> div.dropdown-menu",template:i["@EkynaCommerce/Js/widget.html.twig"],debug:!1}),this.$element=a(this.config.selector),1!=this.$element.length)throw"Widget not found ! ("+this.config.selector+")";this.config.url=this.$element.data("url"),this.dropdownShowHandler=e.bind(this.onDropdownShow,this),this.config.debug||a(window).on("focus",e.bind(this.onWindowFocus,this)),this.defaultData={tag:this.$element.prop("tagName").toLowerCase(),class:this.$element.attr("class"),icon:null};t=this.$element.find(this.config.icon);1===t.length&&(this.defaultData.icon=t.attr("class")),this.initialize()}return{init:function(t){var e,o,n;(t=a.extend({debug:!1,customer:{selector:"#customer-widget",event:"ekyna_commerce.customer",template:i["@EkynaCommerce/Js/widget.html.twig"],debug:!1},cart:{selector:"#cart-widget",event:"ekyna_commerce.cart",template:i["@EkynaCommerce/Js/widget.html.twig"],debug:!1},context:{selector:"#context-widget",event:"ekyna_commerce.context",template:i["@EkynaCommerce/Js/widget.html.twig"],debug:!1}},t)).customer&&(t.customer.debug=t.debug,e=new u(t.customer)),t.cart&&(t.cart.debug=t.debug,o=new u(t.cart)),t.context&&(t.context.debug=t.debug,n=new u(t.context),c.load()),(e||o||n)&&(r.on("ekyna_user.authentication",function(){e&&e.reload(),o&&o.reload(),n&&n.reload()}),o&&(r.on("ekyna_commerce.sale_view_response",function(){o.reload()}),r.on("ekyna_commerce.add_to_cart",function(t){t.success&&o.reload()}))),a(document).on("click",'a[data-resupply-alert]:not([data-resupply-alert=""])',function(t){return!(!t.ctrlKey&&!t.shiftKey&&2!==t.button)||(t.preventDefault(),t.stopPropagation(),(new s).load({url:a(t.currentTarget).data("resupply-alert"),method:"GET"}),!1)}).on("click",'a[data-add-to-cart]:not([data-add-to-cart=""])',function(t){if(t.ctrlKey||t.shiftKey||2===t.button)return!0;t.preventDefault(),t.stopPropagation();var e=new s;return e.load({url:a(t.currentTarget).data("add-to-cart"),method:"GET"}),a(e).on("ekyna.modal.response",function(t){l(t.content,t.jqXHR,t.modal)}),!1}).on("submit",'form[data-add-to-cart]:not([data-add-to-cart=""])',function(t){var i=a(t.currentTarget).closest("form");return t.preventDefault(),t.stopPropagation(),i.loadingSpinner("on"),i.ajaxSubmit({url:i.data("add-to-cart"),success:function(t,e,o){var n=s.prototype.getContentType(o);if("xml"===n&&1===(n=a(t).find("content")).length){n=a(n.text());if(n.is("form"))return i.data("form").destroy(),i.replaceWith(n),i=n.eq(0),void d.create(i).init()}l(t,o,null);n=new s;n.handleResponse(t,e,o),a(n).on("ekyna.modal.response",function(t){l(t.content,t.jqXHR,t.modal)})},complete:function(){i.loadingSpinner("off")}}),!1})},Widget:u}});