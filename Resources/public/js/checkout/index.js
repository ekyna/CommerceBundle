define(["jquery","ekyna-modal","ekyna-dispatcher","ekyna-spinner","jquery/form"],function(o,u,e){"use strict";var t,c={information:"#cart-checkout-information",invoice:"#cart-checkout-invoice",delivery:"#cart-checkout-delivery",comment:"#cart-checkout-comment",attachments:"#cart-checkout-attachments",'content[type="cart"]':"#cart-checkout-content"},l={information:"#cart-checkout-information-button",invoice:"#cart-checkout-invoice-button",delivery:"#cart-checkout-delivery-button",comment:"#cart-checkout-comment-button",attachments:"#cart-checkout-attachments-button"},a=o(".cart-checkout"),i=a.find(".cart-checkout-customer"),f=a.find(".cart-checkout-forms"),h=a.find(".cart-checkout-footer"),r=a.find(".cart-checkout-submit"),d=a.find(".cart-checkout-quote"),s=a.find(".submit-prevented"),n=!1,m=function(e){s.clearQueue().slideUp(function(){s.find(".alert-danger").hide().find("p").empty(),s.find(".alert-warning").show()}),a.find("cart-checkout-button").removeClass("btn-primary").addClass("btn-default disabled");e=o(e).find("view");if(1===e.length){var t=e.data("controls");if(1===t.empty)f.slideUp(),i.slideUp(),h.hide(),r.addClass("disabled").hide(),d.addClass("disabled").hide();else{for(var n in f.show().slideDown(),h.show(),r.show(),l)t.hasOwnProperty(n)&&1===t[n]&&o(l[n]).removeClass("btn-default disabled").addClass("btn-primary");1===t.customer?i.slideUp():(i.show().slideDown(),1===t.user?(i.find(".no-user-case").hide(),i.find(".user-case").show()):(i.find(".no-user-case").show(),i.find(".user-case").hide())),1===t.quote?d.show():d.hide(),1===t.valid?(r.removeClass("disabled"),d.removeClass("disabled")):(r.addClass("disabled"),d.addClass("disabled"))}}};function k(e){var t,n,a=o(e);for(t in c)!c.hasOwnProperty(t)||1===(n=a.find(t)).length&&o(c[t]).html(n.text());m(e);e=a.find("view");return 1===e.length&&(o(".cart-checkout-view").html(o(e.text())),1)}function p(){var e;if(!n)return n=!0,a.loadingSpinner(),e=o.ajax({url:a.data("refresh-url"),dataType:"xml",cache:!1}),e.done(function(e){k(e),a.loadingSpinner("off")}),e.fail(function(){console.log("Failed to update cart checkout content.")}),e.always(function(){n=!1}),1}e.on("ekyna_commerce.sale_view_response",function(e){m(e)}),e.on("ekyna_user.authentication",function(){p()}),e.on("ekyna_commerce.add_to_cart",function(e){e.success&&p()}),a.on("click",".cart-checkout-footer a.btn",function(e){if(e.stopPropagation(),o(e.target).closest("a.btn").hasClass("disabled"))return e.preventDefault(),s.clearQueue().slideDown(),!1}),o(document).on("click",".cart-checkout [data-cart-modal]",function(e){e.preventDefault();var e=o(this),t=new u;return t.load({url:e.attr("href")}),o(t).on("ekyna.modal.response",function(e){"xml"===e.contentType&&k(e.content)&&(e.preventDefault(),e.modal.close())}),!1}),o(document).on("click",".cart-checkout [data-cart-xhr]",function(e){e.preventDefault();e=o(this).data("confirm");return e&&e.length&&!confirm(e)||o.ajax({url:o(this).attr("href"),method:"post",dataType:"xml"}).done(function(e){k(e)}),!1}),o("html").data("debug")||(t=!1,o(window).on("focus",function(){!t&&p()&&(t=!0,setTimeout(function(){t=!1},1e4))}))});