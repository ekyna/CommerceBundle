define(["jquery","underscore","router","ekyna-modal","ekyna-dispatcher","ekyna-spinner","jquery/form","bootstrap"],function(o,u,f,p,g){"use strict";let i,l,a=[],s=null;function d(e){return e.offsetY<this.clientHeight/2}function t(){this.classList.remove("drop-after"),this.classList.remove("drop-before")}function v(e){if(!this.classList.contains("sale-detail-item"))return e.preventDefault(),!1;(s=this).style.opacity="0.5",e.dataTransfer.effectAllowed="move"}function n(e){s=null,this.style.opacity="1",a.forEach(function(e){t.apply(e)})}function h(e){!function(e){d.apply(this,[e])?(this.classList.add("drop-before"),this.classList.remove("drop-after")):(this.classList.add("drop-after"),this.classList.remove("drop-before"))}.apply(this,[e])}function m(e){e.preventDefault()}function y(e){t.apply(this)}function r(){o('.sale-view [data-toggle="popover"]').popover({trigger:"hover",placement:"top",html:!0,sanitize:!1});let e=o(".sale-view"),t=(i=e.data("type"),l=e.data("id"),u.throttle(h,400,{trailing:!1}));(a=document.querySelectorAll(".sale-detail tr[draggable=true]")).forEach(function(e){e.addEventListener("dragstart",v),e.addEventListener("dragend",n),e.addEventListener("dragenter",m),e.addEventListener("dragover",function(e){e.preventDefault(),t.apply(this,[e])}),e.addEventListener("dragleave",y),e.addEventListener("dragend",n)})}function c(e,t){var a=o(e).find("view");return 1===a.length&&(t.replaceWith(o(a.text())),g.trigger("ekyna_commerce.sale_view_response",e),r(),1)}document.addEventListener("drop",function(r){if(r.stopPropagation(),console.log("Item Drop"),console.log(r),s){let n=r.target;for(;"TR"!==n.nodeName;)if(!(n=n.parentNode))return;if("TR"===n.nodeName&&n.classList.contains("sale-detail-item")&&n!==s){let t=o(n).closest(".sale-view"),e=(t.loadingSpinner(),{}),a=(e[i+"Id"]=l,e[i+"ItemId"]=s.attributes.getNamedItem("data-id").value,e.targetId=n.attributes.getNamedItem("data-id").value,e.mode=d.apply(r.target,[r])?"before":"after",o.ajax({url:f.generate("admin_ekyna_commerce_"+i+"_item_move",e),method:"GET",dataType:"xml"}));return a.done(function(e){c(e,t)}),!1}}}),o(document).on("click",".sale-view [data-sale-modal]",function(e){e.preventDefault();var e=o(this),t=e.closest(".sale-view"),a=new p;return a.load({url:e.attr("href")}),o(a).on("ekyna.modal.response",function(e){"xml"===e.contentType&&c(e.content,t)&&(e.preventDefault(),e.modal.close())}),!1}),o(document).on("click",".sale-view [data-sale-xhr]",function(e){e.preventDefault();var e=o(this),t=e.data("confirm");if(t&&t.length&&!confirm(t))return!1;var a=e.closest(".sale-view"),t=e.data("sale-xhr");return a.loadingSpinner(),o.ajax({url:o(this).attr("href"),method:t||"post",dataType:"xml"}).done(function(e){c(e,a)}),!1}),o(document).on("click",".sale-view [data-sale-toggle-all-children]",function(e){e.stopPropagation(),e.preventDefault();var e=o(e.currentTarget).closest(".sale-view").find("tr[data-parent]"),t=e.filter(":not(:visible)").length;return e.filter(":visible").length<t?e.show():e.hide(),!1}),o(document).on("click",".sale-view [data-sale-toggle-children]",function(e){e.stopPropagation(),e.preventDefault();var e=o(e.currentTarget),r=e.closest(".sale-view"),t=e.data("sale-toggle-children"),a=!!e.data("sale-toggle-shown");return t&&(t=r.find('tr[data-parent="'+t+'"]'),a?function n(e){e.each(function(){o(this).hide().find("[data-sale-toggle-children]").each(function(){var e=o(this),t=e.data("sale-toggle-children"),a=!!e.data("sale-toggle-shown");t&&a&&(n(r.find('tr[data-parent="'+t+'"]')),e.data("sale-toggle-shown",!1))})})}(t):t.show(),e.data("sale-toggle-shown",!a)),!1}),o(document).on("submit",".sale-view form",function(e){e.preventDefault();var t=o(e.target).closest(".sale-view").loadingSpinner();return o(e.target).closest("form").ajaxSubmit({dataType:"xml",success:function(e){c(e,t)}}),!1}),r()});