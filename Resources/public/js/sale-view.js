define(["jquery","ekyna-modal","ekyna-dispatcher","ekyna-spinner","jquery/form","bootstrap"],function(r,n,o){"use strict";function l(){r('.sale-view [data-toggle="popover"]').popover({trigger:"hover",placement:"top",html:!0,sanitize:!1})}function i(e,t){var a=r(e).find("view");return 1===a.length&&(t.replaceWith(r(a.text())),o.trigger("ekyna_commerce.sale_view_response",e),l(),1)}r(document).on("click",".sale-view [data-sale-modal]",function(e){e.preventDefault();var e=r(this),t=e.closest(".sale-view"),a=new n;return a.load({url:e.attr("href")}),r(a).on("ekyna.modal.response",function(e){"xml"===e.contentType&&i(e.content,t)&&(e.preventDefault(),e.modal.close())}),!1}),r(document).on("click",".sale-view [data-sale-xhr]",function(e){e.preventDefault();var e=r(this),t=e.data("confirm");if(t&&t.length&&!confirm(t))return!1;var a=e.closest(".sale-view"),t=e.data("sale-xhr");return a.loadingSpinner(),r.ajax({url:r(this).attr("href"),method:t||"post",dataType:"xml"}).done(function(e){i(e,a)}),!1}),r(document).on("click",".sale-view [data-sale-toggle-all-children]",function(e){e.stopPropagation(),e.preventDefault();var e=r(e.currentTarget).closest(".sale-view").find("tr[data-parent]"),t=e.filter(":not(:visible)").length;return e.filter(":visible").length<t?e.show():e.hide(),!1}),r(document).on("click",".sale-view [data-sale-toggle-children]",function(e){e.stopPropagation(),e.preventDefault();var e=r(e.currentTarget),o=e.closest(".sale-view"),t=e.data("sale-toggle-children"),a=!!e.data("sale-toggle-shown");return t&&(t=o.find('tr[data-parent="'+t+'"]'),a?function n(e){e.each(function(){r(this).hide().find("[data-sale-toggle-children]").each(function(){var e=r(this),t=e.data("sale-toggle-children"),a=!!e.data("sale-toggle-shown");t&&a&&(n(o.find('tr[data-parent="'+t+'"]')),e.data("sale-toggle-shown",!1))})})}(t):t.show(),e.data("sale-toggle-shown",!a)),!1}),r(document).on("submit",".sale-view form",function(e){e.preventDefault();var t=r(e.target).closest(".sale-view").loadingSpinner();return r(e.target).closest("form").ajaxSubmit({dataType:"xml",success:function(e){i(e,t)}}),!1}),l()});