define(["jquery","underscore","router","ekyna-modal","ekyna-dispatcher","ekyna-spinner","jquery/form","bootstrap"],function(l,e,s,r,h){"use strict";let d,c,u=[],i=null;function o(e){return e.offsetY<this.clientHeight/2}function t(){this.classList.remove("drop-after"),this.classList.remove("drop-before")}function g(e){if(!this.classList.contains("sale-detail-item"))return e.preventDefault(),!1;(i=this).style.opacity="0.5",e.dataTransfer.effectAllowed="move"}function f(e){i=null,this.style.opacity="1",u.forEach(function(e){t.apply(e)})}function m(e){!function(e){o.apply(this,[e])?(this.classList.add("drop-before"),this.classList.remove("drop-after")):(this.classList.add("drop-after"),this.classList.remove("drop-before"))}.apply(this,[e])}function v(e){e.preventDefault()}function y(e){t.apply(this)}function b(){l('.sale-view [data-toggle="popover"]').popover({trigger:"hover",placement:"top",html:!0,sanitize:!1});let n=document.querySelector(".sale-view"),r=l(".sale-view"),t=(d=n.getAttribute("data-type"),c=n.getAttribute("data-id"),e.throttle(m,400,{trailing:!1})),i=((u=n.querySelectorAll(".sale-detail tr[draggable=true]")).forEach(function(e){e.addEventListener("dragstart",g),e.addEventListener("dragend",f),e.addEventListener("dragenter",v),e.addEventListener("dragover",function(e){e.preventDefault(),t.apply(this,[e])}),e.addEventListener("dragleave",y),e.addEventListener("dragend",f)}),n.querySelectorAll('input[name="sale[items][]"]')),o=n.querySelectorAll("button[type=button].sale-view-batch");function a(){let e=!0;for(var t of i.values())if(t.checked){e=!1;break}var a=e?function(e){e.classList.add("disabled"),e.setAttribute("disabled","disabled")}:function(e){e.classList.remove("disabled"),e.removeAttribute("disabled")};o.forEach(a)}i.forEach(e=>{e.addEventListener("change",a)}),a(),o.forEach(e=>{e.addEventListener("click",a=>{if(a.preventDefault(),!e.hasAttribute("data-confirm")||confirm(e.getAttribute("data-confirm"))){r.loadingSpinner();let t=new FormData,e=(n.querySelectorAll('input[name="sale[items][]"]:checked').forEach(e=>{t.append("sale[items][]",e.value)}),{});e[d+"Id"]=c,e.action=a.target.getAttribute("data-action");a=s.generate("admin_ekyna_commerce_"+d+"_batch",e),a=new Request(a,{method:"post",body:t});fetch(a).then(e=>{e.ok&&e.text().then(e=>{p((new DOMParser).parseFromString(e,"application/xml"),r)})})}})})}function p(e,t){let a=l(e),n=a.find("view");return 1===n.length&&(t.replaceWith(l(n.text())),h.trigger("ekyna_commerce.sale_view_response",e),b(),1)}document.addEventListener("drop",function(r){if(r.stopPropagation(),i){let n=r.target;for(;"TR"!==n.nodeName;)if(!(n=n.parentNode))return;if("TR"===n.nodeName&&n.classList.contains("sale-detail-item")&&n!==i){let t=l(n).closest(".sale-view"),e=(t.loadingSpinner(),{}),a=(e[d+"Id"]=c,e[d+"ItemId"]=i.getAttribute("data-id"),e.targetId=n.getAttribute("data-id"),e.mode=o.apply(r.target,[r])?"before":"after",l.ajax({url:s.generate("admin_ekyna_commerce_"+d+"_item_move",e),method:"GET",dataType:"xml"}));return a.done(function(e){p(e,t)}),!1}}}),l(document).on("click",".sale-view [data-sale-modal]",function(e){e.preventDefault();let t=l(this),a=t.closest(".sale-view"),n=new r;return n.load({url:t.attr("href")}),l(n).on("ekyna.modal.response",function(e){"xml"===e.contentType&&p(e.content,a)&&(e.preventDefault(),e.modal.close())}),!1}),l(document).on("click",".sale-view [data-sale-xhr]",function(e){e.preventDefault();let t=l(this),a=t.data("confirm");if(a&&a.length&&!confirm(a))return!1;let n=t.closest(".sale-view"),r=t.data("sale-xhr"),i=(n.loadingSpinner(),l.ajax({url:l(this).attr("href"),method:r||"post",dataType:"xml"}));return i.done(function(e){p(e,n)}),!1}),l(document).on("click",".sale-view [data-sale-toggle-all-children]",function(e){e.stopPropagation(),e.preventDefault();let t=l(e.currentTarget),a=t.closest(".sale-view"),n=a.find("tr[data-parent]"),r=n.filter(":not(:visible)").length,i=n.filter(":visible").length;return i<r?n.show():n.hide(),!1}),l(document).on("click",".sale-view [data-sale-toggle-children]",function(e){e.stopPropagation(),e.preventDefault();let t=l(e.currentTarget),r=t.closest(".sale-view"),a=t.data("sale-toggle-children"),n=!!t.data("sale-toggle-shown");if(a){let e=r.find('tr[data-parent="'+a+'"]');n?function n(e){e.each(function(){l(this).hide().find("[data-sale-toggle-children]").each(function(){let e=l(this),t=e.data("sale-toggle-children"),a=!!e.data("sale-toggle-shown");t&&a&&(n(r.find('tr[data-parent="'+t+'"]')),e.data("sale-toggle-shown",!1))})})}(e):e.show(),t.data("sale-toggle-shown",!n)}return!1}),l(document).on("submit",".sale-view form",function(e){e.preventDefault();let t=l(e.target).closest(".sale-view").loadingSpinner();return l(e.target).closest("form").ajaxSubmit({dataType:"xml",success:function(e){p(e,t)}}),!1}),b()});