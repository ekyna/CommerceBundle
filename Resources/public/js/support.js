define(["require","exports","jquery","routing","ekyna-commerce/templates","ekyna-spinner","bootstrap","ekyna-modal"],function(a,b,c,d,e,f,g,h){"use strict";Object.defineProperty(b,"__esModule",{value:!0});var i,j,k=function(){function a(a){this.$element=a,this.tickets=[],a.data("support",this)}return a.prototype.init=function(){var a=this;return this.$element.find(".ticket").each(function(b,d){a.tickets.push(new l(a,c(d)).init())}),this.$element.on("click",".ticket-new",function(b){a.request(c(b.currentTarget).data("url"))}),this.tickets.length&&this.tickets[0].show(),this},a.prototype.findTicket=function(a){var b=null;return this.tickets.forEach(function(c){if(c.getId()===a)return b=c,!1}),b},a.prototype.request=function(a,b){var d=this,e=new h;e.load({url:a}),c(e).on("ekyna.modal.response",function(a){"json"===a.contentType&&(d.parse(a.content),b&&b(),e.close())})},a.prototype.createTicket=function(a){var b=c(e["@EkynaCommerce/Js/ticket.html.twig"].render({ticket:a,trans:i,config:j}));this.$element.find(".tickets").prepend(b),this.tickets.forEach(function(a){a.hide()}),this.tickets.push(new l(this,b).init().show()),this.$element.find(".no-tickets").hide()},a.prototype.removeTicket=function(a){var b;this.tickets.forEach(function(c,d){if(c.getId()===a)return c["delete"](),b=d,!1}),b&&this.tickets.splice(b,1)},a.prototype.parse=function(a){if(a.ticket){var b=this.findTicket(a.ticket.id);b?b.update(a.ticket):this.createTicket(a.ticket)}if(a.ticketMessage){var b=this.findTicket(a.ticketMessage.ticket);if(!b)throw"Ticket not found.";var c=b.findMessage(a.ticketMessage.id);c?c.update(a.ticketMessage):b.createMessage(a.ticketMessage)}if(a.ticketAttachment){var b=this.findTicket(a.ticketAttachment.ticket);if(!b)throw"Ticket not found.";var c=b.findMessage(a.ticketAttachment.message);if(!c)throw"Message not found.";var d=c.findAttachment(a.ticketAttachment.id);d?d.update(a.ticketAttachment):c.createAttachment(a.ticketAttachment)}},a}(),l=function(){function a(a,b){this.id=b.data("id"),this.support=a,this.$element=b,this.messages=[],b.data("ticket",this)}return a.prototype.init=function(){var b=this;return this.$element.find(".message").each(function(a,d){b.messages.push(new m(b,c(d)).init())}),this.$element.on("click",".message-new",function(){return b.newMessage()}),this.$element.on("click",".ticket-edit",function(){return b.edit()}),this.$element.on("click",".ticket-remove",function(){return b.remove()}),this.$element.on("click",".ticket-close",function(){return b.close()}),this.$element.on("click",".ticket-open",function(){return b.open()}),this.$element.on("click",".customer-show",function(b){return a.showCustomer(b)}),this.$element.on("click",".order-show",function(b){return a.showOrder(b)}),this.$element.on("click",".quote-show",function(b){return a.showQuote(b)}),this},a.showCustomer=function(a){if(a.preventDefault(),a.stopPropagation(),j.admin)return window.open(d.generate(j.routes.order+"_read",{customerId:c(a.target).data("id")}),"_blank").focus(),!1},a.showOrder=function(a){a.preventDefault(),a.stopPropagation();var b;return b=j.admin?{orderId:c(a.target).data("id")}:{number:c(a.target).text()},window.open(d.generate(j.routes.order+"_read",b),"_blank").focus(),!1},a.showQuote=function(a){a.preventDefault(),a.stopPropagation();var b;return b=j.admin?{quoteId:c(a.target).data("id")}:{number:c(a.target).text()},window.open(d.generate(j.routes.quote+"_read",b),"_blank").focus(),!1},a.prototype.getId=function(){return this.id},a.prototype.getSupport=function(){return this.support},a.prototype.newMessage=function(){this.support.request(d.generate(j.routes.message+"_create",{ticketId:this.id}))},a.prototype.edit=function(){this.support.request(d.generate(j.routes.ticket+"_update",{ticketId:this.id}))},a.prototype.remove=function(){var a=this;this.support.request(d.generate(j.routes.ticket+"_delete",{ticketId:this.id}),function(){a.support.removeTicket(a.id),a["delete"]()})},a.prototype.open=function(){this.support.request(d.generate(j.routes.ticket+"_open",{ticketId:this.id}))},a.prototype.close=function(){this.support.request(d.generate(j.routes.ticket+"_close",{ticketId:this.id}))},a.prototype.findMessage=function(a){var b=null;return this.messages.forEach(function(c){if(c.getId()===a)return b=c,!1}),b},a.prototype.createMessage=function(a){var b=c(e["@EkynaCommerce/Js/ticket_message.html.twig"].render({message:a,trans:i,config:j}));this.$element.find(".messages").append(b),this.messages.push(new m(this,b).init())},a.prototype.removeMessage=function(a){var b;this.messages.forEach(function(c,d){if(c.getId()===a)return c["delete"](),b=d,!1}),b&&this.messages.splice(b,1)},a.prototype.update=function(a){if(a.expanded=!0,void 0!==a.messages){var b=c(e["@EkynaCommerce/Js/ticket.html.twig"].render({ticket:a,trans:i,config:j}));return this.$element.replaceWith(b),this.$element=b,void this.init()}this.$element.find(".ticket-header").html(e["@EkynaCommerce/Js/ticket_header.html.twig"].render({ticket:a,trans:i,config:j})),this.$element.find(".ticket-body").html(e["@EkynaCommerce/Js/ticket_body.html.twig"].render({ticket:a,trans:i,config:j})),this.$element.find(".ticket-footer").html(e["@EkynaCommerce/Js/ticket_footer.html.twig"].render({ticket:a,trans:i,config:j}))},a.prototype["delete"]=function(){this.$element.remove()},a.prototype.show=function(){return this.$element.find(".collapse").collapse("show"),this},a.prototype.hide=function(){return this.$element.find(".collapse").collapse("hide"),this},a}(),m=function(){function a(a,b){this.id=b.data("id"),this.ticket=a,this.$element=b,b.data("message",this)}return a.prototype.init=function(){var a=this;return this.attachments=[],this.$element.find(".attachment").each(function(b,d){a.attachments.push(new n(a,c(d)).init())}),this.$element.on("click",".attachment-new",function(){return a.newAttachment()}),this.$element.on("click",".message-edit",function(){return a.edit()}),this.$element.on("click",".message-remove",function(){return a.remove()}),this},a.prototype.getId=function(){return this.id},a.prototype.getTicket=function(){return this.ticket},a.prototype.newAttachment=function(){this.ticket.getSupport().request(d.generate(j.routes.attachment+"_create",{ticketId:this.ticket.getId(),ticketMessageId:this.id}))},a.prototype.edit=function(){this.ticket.getSupport().request(d.generate(j.routes.message+"_update",{ticketId:this.ticket.getId(),ticketMessageId:this.id}))},a.prototype.remove=function(){var a=this;this.ticket.getSupport().request(d.generate(j.routes.message+"_delete",{ticketId:this.ticket.getId(),ticketMessageId:this.id}),function(){a.ticket.removeMessage(a.id),a["delete"]()})},a.prototype.findAttachment=function(a){var b=null;return this.attachments.forEach(function(c){if(c.getId()===a)return b=c,!1}),b},a.prototype.createAttachment=function(a){var b=c(e["@EkynaCommerce/Js/ticket_attachment.html.twig"].render({attachment:a,trans:i,config:j}));this.$element.find(".attachments").append(b),this.attachments.push(new n(this,b).init())},a.prototype.removeAttachment=function(a){var b;this.attachments.forEach(function(c,d){if(c.getId()===a)return c["delete"](),b=d,!1}),b&&this.attachments.splice(b,1)},a.prototype.update=function(a){var b=c(e["@EkynaCommerce/Js/ticket_message.html.twig"].render({message:a,trans:i,config:j}));this.$element.replaceWith(b),this.$element=b,this.init()},a.prototype["delete"]=function(){this.$element.remove()},a}(),n=function(){function a(a,b){this.id=b.data("id"),this.message=a,this.$element=b,b.data("attachment",this)}return a.prototype.init=function(){var a=this;return this.$element.on("click",".attachment-download",function(){return a.download()}),this.$element.on("click",".attachment-edit",function(){return a.edit()}),this.$element.on("click",".attachment-remove",function(){return a.remove()}),this},a.prototype.getId=function(){return this.id},a.prototype.download=function(){window.open(d.generate(j.routes.attachment+"_download",{ticketId:this.message.getTicket().getId(),ticketMessageId:this.message.getId(),ticketAttachmentId:this.id}),"_blank").focus()},a.prototype.edit=function(){this.message.getTicket().getSupport().request(d.generate(j.routes.attachment+"_update",{ticketId:this.message.getTicket().getId(),ticketMessageId:this.message.getId(),ticketAttachmentId:this.id}))},a.prototype.remove=function(){var a=this;this.message.getTicket().getSupport().request(d.generate(j.routes.attachment+"_delete",{ticketId:this.message.getTicket().getId(),ticketMessageId:this.message.getId(),ticketAttachmentId:this.id}),function(){a.message.removeAttachment(a.id),a["delete"]()})},a.prototype.update=function(a){var b=c(e["@EkynaCommerce/Js/ticket_attachment.html.twig"].render({attachment:a,trans:i,config:j}));this.$element.replaceWith(b),this.$element=b,this.init()},a.prototype["delete"]=function(){this.$element.remove()},a}(),o=c("#commerce-support");1===o.length?(i=o.data("trans"),j=o.data("config"),new k(o).init()):console.error("Support root not found.")});